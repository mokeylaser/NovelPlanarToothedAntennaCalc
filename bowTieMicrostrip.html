<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>Bowtie Antenna Calculator</title>
    <!-- MathJax for LaTeX rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
    <!-- Tippy.js for tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components/calculator.css">
    <!-- <link rel="stylesheet" href="css/components/visualization.css"> -->
    <!-- <link rel="stylesheet" href="css/components/controls.css"> -->
    <style>
        /* Additional styles specific to bowtie calculator if needed */
        .tab-buttons {
            display: flex;
            margin-bottom: var(--spacing-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xs);
        }

        .tab-button {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-base);
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        .tab-button.active {
            background: var(--bg-primary);
            color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn var(--transition-slow) ease-out;
        }
        .results-card .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
        }
        .results-card .result-item:last-child {
            border-bottom: none;
        }
        .results-card .result-label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        .results-card .result-value {
            font-family: var(--font-mono);
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg-tertiary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }
        .note-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
            border-left: 4px solid var(--warning-color);
        }
        .note-card p {
            color: var(--text-secondary); /* Or a more specific warning text color */
            font-size: 0.875rem;
            margin-bottom: 0;
        }
        .note-card strong {
            color: var(--text-primary); /* Or a more specific warning text color */
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Bowtie Antenna Calculator</h1>
            <p class="subtitle">Design and analyze bowtie printed antennas with precision</p>
            <p class="subtitle">Calculator by KC3VJA</p>
        </header>

        <main class="app-main">
            <div class="content-grid">
                <!-- Calculator Section -->
                <section class="calculator-section">
                    <div class="card">
                        <h2>Design Parameters</h2>
                        <div class="tab-buttons">
                            <button class="tab-button active" onclick="switchTab('forward', this)">Parameters → Frequency</button>
                            <button class="tab-button" onclick="switchTab('reverse', this)">Frequency → Parameters</button>
                        </div>

                        <form id="calculator-form-forward" class="tab-content active">
                            <div class="form-group">
                                <label for="eps_r" data-tippy-content="Relative permittivity of the substrate material (e.g., FR4 is typically around 4.4).">Substrate Relative Permittivity (εᵣ)</label>
                                <input type="number" id="eps_r" value="4.4" step="0.1" min="1" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="h" data-tippy-content="Thickness of the substrate material.">Substrate Thickness (h) [mm]</label>
                                <input type="number" id="h" value="1.6" step="0.1" min="0.1" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="W" data-tippy-content="Width of the bowtie arm at its widest point (outer edge).">Mouth Width at Outer Edge (W) [mm]</label>
                                <input type="number" id="W" value="18" step="0.1" min="0.1" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="Wc" data-tippy-content="Width of the feed gap where the signal is introduced.">Width at Feed Gap (Wc) [mm]</label>
                                <input type="number" id="Wc" value="3" step="0.1" min="0.1" required>
                                 <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="L" data-tippy-content="Length of one triangular wing of the bowtie, from the feed point to the outer edge along the centerline.">Half-Height of Triangular Wing (L) [mm]</label>
                                <input type="number" id="L" value="25" step="0.1" min="0.1" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="S" data-tippy-content="Length of the slanted edge of the bowtie arm.">Slanted-Edge Length (S) [mm]</label>
                                <input type="number" id="S" value="20" step="0.1" min="0.1" required>
                                <span class="error-message"></span>
                            </div>
                            <button type="button" class="calculate-btn" onclick="calculateForward()">Calculate Frequency</button>
                        </form>

                        <form id="calculator-form-reverse" class="tab-content">
                            <div class="form-group">
                                <label for="target_freq" data-tippy-content="The desired center resonant frequency for the antenna design.">Target Center Frequency [GHz]</label>
                                <input type="number" id="target_freq" value="2.4" step="0.1" min="0.1" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="eps_r_rev" data-tippy-content="Relative permittivity of the substrate material.">Substrate Relative Permittivity (εᵣ)</label>
                                <input type="number" id="eps_r_rev" value="4.4" step="0.1" min="1" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="h_rev" data-tippy-content="Thickness of the substrate material.">Substrate Thickness (h) [mm]</label>
                                <input type="number" id="h_rev" value="1.6" step="0.1" min="0.1" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="k_factor" data-tippy-content="Phase difference factor, typically between 0.3 and 0.6. Affects quality factor (Q).">K Factor (Phase Difference)</label>
                                <input type="number" id="k_factor" value="0.4" step="0.01" min="0.3" max="0.6" required>
                                <span class="error-message"></span>
                            </div>
                            <div class="form-group">
                                <label for="flare_angle" data-tippy-content="The total angle of the bowtie flare, typically between 30° and 120°.">Flare Angle [degrees]</label>
                                <input type="number" id="flare_angle" value="90" step="1" min="30" max="120" required>
                                <span class="error-message"></span>
                            </div>
                            <button type="button" class="calculate-btn" onclick="calculateReverse()">Calculate Parameters</button>
                        </form>
                    </div>
                </section>

                <!-- Results Section -->
                <section class="results-section">
                    <div class="card results-card" id="results-card-bow">
                        <h2>Calculation Results</h2>
                        <div id="results-container-bow">
                            <p class="placeholder-text" style="text-align: center; padding: 40px 0;">Enter parameters and click calculate to see results</p>
                        </div>
                    </div>
                    <div class="card note-card">
                         <p><strong>Note:</strong> These calculations provide first-order estimates. Fine-tuning in an EM solver (HFSS, CST, Sonnet, etc.) is recommended for optimal performance.</p>
                    </div>
                </section>
            </div>
        </main>

        <footer class="app-footer">
            © 2025 Mark Richards
            <p class="app-footer-text">
                Bowtie formula based on general microstrip antenna design principles.
            </p>
             <a href="index.html" class="reference-link" style="display: block; margin-top: 10px;">Back to Toothed Antenna Calculator</a>
        </footer>
    </div>

    <script>
        const C0 = 299792458; // speed of light (m/s)

        function epsEff(eps_r, h, W, Wc) {
            // Ensure h, W, Wc are in meters for this formula if they are not already
            return 0.5 * (eps_r + 1) + 0.5 * (eps_r - 1) * Math.pow(1 + 24 * h / (W + Wc), -0.5);
        }

        function deltaL(h, eps_eff_val, W, Wc) {
            // Ensure h, W, Wc are in meters
            const k_val = (W + Wc) / (2 * h); // Corrected variable name from k to k_val
            return (0.412 * h * (eps_eff_val + 0.3) * (k_val + 0.262)) / ((eps_eff_val - 0.258) * (k_val + 0.813));
        }

        function resonanceFreq(L_param, W_param, Wc_param, S_param, h_param, eps_r_param) {
            // Parameters L, W, Wc, S, h should be in meters
            const eps_eff_val = epsEff(eps_r_param, h_param, W_param, Wc_param);
            const dL_val = deltaL(h_param, eps_eff_val, W_param, Wc_param); // Corrected variable name
            const num = (W_param + 2 * dL_val) + (Wc_param + 2 * dL_val);
            const den = (W_param + 2 * dL_val) * (S_param + 2 * dL_val);
             // Original formula had L in denominator, which might be a typo or specific context.
             // A more common approach for bowtie might relate L to wavelength directly.
             // The provided formula: (1.152 * C0 * num) / (2 * L_param * den * Math.sqrt(eps_eff_val))
             // This seems unusual. Let's assume it's from a specific paper.
             // If L_param is intended to be the resonant length, it might be related to lambda_g / 2.
             // The formula seems to be solving for frequency given L.
            return (1.152 * C0 * num) / (2 * L_param * den * Math.sqrt(eps_eff_val));
        }

        function calculateQuality(k_factor_param, angle_deg) { // Corrected variable name
            const angle_rad = angle_deg * Math.PI / 180;
            return 1 / (k_factor_param * Math.tan(angle_rad / 2));
        }

        function calculateBandwidth(frequency, Q_val) { // Corrected variable name
            return frequency / Q_val;
        }

        function calculateWavelength(frequency) {
            return C0 / frequency;
        }

        function calculateImpedance(L_param, G_param) { // G is gap, ensure units are consistent
            return 60 * Math.log(2 * L_param / G_param); // This is a simplified formula, often for dipoles.
                                                  // For microstrip bowties, it can be more complex.
        }

        function switchTab(tabName, element) {
            document.querySelectorAll('.tab-button').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'forward') {
                document.getElementById('calculator-form-forward').classList.add('active');
            } else {
                document.getElementById('calculator-form-reverse').classList.add('active');
            }
        }

        function validateAndGet(id, unitConversion = 1) {
            const inputElement = document.getElementById(id);
            const value = parseFloat(inputElement.value);
            const errorElement = inputElement.nextElementSibling; // Assuming error span is next sibling

            if (isNaN(value) || value <= 0 && inputElement.min !== undefined && parseFloat(inputElement.min) <= 0) {
                 if (inputElement.min !== undefined && parseFloat(inputElement.min) > 0 && value <=0) {
                    errorElement.textContent = `Value must be greater than ${inputElement.min}.`;
                    throw new Error(`Validation failed for ${id}`);
                 } else if (isNaN(value)) {
                    errorElement.textContent = 'Please enter a valid number.';
                    throw new Error(`Validation failed for ${id}`);
                 }
            }
            errorElement.textContent = ''; // Clear error
            return value * unitConversion;
        }


        function calculateForward() {
            try {
                clearResults();
                const eps_r = validateAndGet('eps_r');
                const h = validateAndGet('h', 0.001); // mm to m
                const W = validateAndGet('W', 0.001); // mm to m
                const Wc = validateAndGet('Wc', 0.001); // mm to m
                const L = validateAndGet('L', 0.001); // mm to m
                const S = validateAndGet('S', 0.001); // mm to m

                const freq = resonanceFreq(L, W, Wc, S, h, eps_r);
                if (isNaN(freq) || !isFinite(freq)) {
                    displayError('Calculation resulted in an invalid frequency. Please check input parameters, especially S, W, Wc relative to L.');
                    return;
                }
                const eps_eff_val = epsEff(eps_r, h, W, Wc);
                const dL_val = deltaL(h, eps_eff_val, W, Wc);
                const wavelength_val = calculateWavelength(freq); // Corrected variable name
                
                const estimated_gap_for_impedance = Wc; // Using Wc as the gap for impedance calculation
                const impedance = calculateImpedance(L, estimated_gap_for_impedance);
                // Assuming a default flare angle of 90 for Q if not specified otherwise for forward calc
                const Q_val = calculateQuality(0.4, 90);
                const bandwidth = calculateBandwidth(freq, Q_val);

                displayResults([
                    { label: 'Resonance Frequency', value: (freq / 1e9).toFixed(3) + ' GHz' },
                    { label: 'Effective Permittivity (ε<sub>eff</sub>)', value: eps_eff_val.toFixed(3) },
                    { label: 'Fringing Extension (ΔL)', value: (dL_val * 1000).toFixed(3) + ' mm' },
                    { label: 'Wavelength (λ)', value: (wavelength_val * 1000).toFixed(1) + ' mm' },
                    { label: 'Input Impedance (Z<sub>in</sub>)', value: impedance.toFixed(1) + ' Ω' },
                    { label: 'Quality Factor (Q)', value: Q_val.toFixed(1) },
                    { label: 'Bandwidth (-3dB)', value: (bandwidth / 1e6).toFixed(1) + ' MHz' }
                ], 'results-container-bow');
            } catch (error) {
                // Error already displayed by validateAndGet or explicitly by displayError
                console.error("Calculation Error:", error);
            }
        }

        function calculateReverse() {
            try {
                clearResults();
                const target_freq = validateAndGet('target_freq', 1e9); // GHz to Hz
                const eps_r_rev = validateAndGet('eps_r_rev');
                const h_rev = validateAndGet('h_rev', 0.001); // mm to m
                const k_factor = validateAndGet('k_factor');
                const flare_angle = validateAndGet('flare_angle');

                const wavelength_val = calculateWavelength(target_freq);
                
                // Simplified design: L is often related to lambda_eff / 2 for resonance.
                // For a bowtie, each arm is roughly lambda_eff / 4.
                // This requires iterative solution or more complex formulas not provided.
                // Using a common approximation: L_arm ~ lambda_0 / (2 * sqrt(eps_eff_avg))
                // Let's use a simplified L based on quarter wavelength in free space as a starting point,
                // then acknowledge it's an approximation.
                // A more direct approach from target frequency to dimensions often involves specific design curves or iterative solver.
                // The formulas provided don't directly give L, W, S, Wc from frequency.
                // We can estimate L based on quarter-wave and then derive others.
                
                // Estimate initial L (e.g. quarter of effective wavelength)
                // This is a rough estimate as eps_eff depends on W, Wc which are unknown.
                // Let's assume an initial eps_eff close to eps_r for a rough L.
                const L_estimated = wavelength_val / (4 * Math.sqrt((eps_r_rev + 1) / 2)); // Very rough estimate for one arm length
                
                const L_final_mm = (L_estimated * 1000).toFixed(1); // Placeholder
                const W_final_mm = (2 * L_estimated * Math.tan(flare_angle * Math.PI / 360) * 1000).toFixed(1); // Width based on L and flare angle
                const S_final_mm = (L_estimated / Math.cos(flare_angle * Math.PI / 360) * 1000).toFixed(1); // Slant length
                const Wc_final_mm = (W_final_mm * 0.1).toFixed(2); // Feed gap as 10% of W, placeholder

                // Recalculate eps_eff with these estimated dimensions for consistency
                const eps_eff_final = epsEff(eps_r_rev, h_rev, parseFloat(W_final_mm)/1000, parseFloat(Wc_final_mm)/1000);

                const Q_val = calculateQuality(k_factor, flare_angle);
                const bandwidth = calculateBandwidth(target_freq, Q_val);
                const impedance = calculateImpedance(L_estimated, parseFloat(Wc_final_mm)/1000);


                displayResults([
                    { label: 'Target Frequency', value: (target_freq / 1e9).toFixed(3) + ' GHz' },
                    { label: 'Wavelength (λ<sub>0</sub>)', value: (wavelength_val * 1000).toFixed(1) + ' mm' },
                    { label: 'Est. Arm Length (L)', value: `${L_final_mm} mm (approx.)` },
                    { label: 'Est. Mouth Width (W)', value: `${W_final_mm} mm (approx.)` },
                    { label: 'Est. Slant Length (S)', value: `${S_final_mm} mm (approx.)` },
                    { label: 'Est. Feed Gap (Wc)', value: `${Wc_final_mm} mm (approx.)` },
                    { label: 'Effective Permittivity (ε<sub>eff</sub>)', value: eps_eff_final.toFixed(3) },
                    { label: 'Input Impedance (Z<sub>in</sub>)', value: `${impedance.toFixed(1)} Ω (approx.)` },
                    { label: 'Quality Factor (Q)', value: Q_val.toFixed(1) },
                    { label: 'Bandwidth (-3dB)', value: (bandwidth / 1e6).toFixed(1) + ' MHz' }
                ], 'results-container-bow');
                 document.querySelector('#results-card-bow .placeholder-text').style.display = 'none';
            } catch (error) {
                 console.error("Calculation Error:", error);
            }
        }
        function clearResults() {
            const resultsDiv = document.getElementById('results-container-bow');
            const placeholder = document.querySelector('#results-card-bow .placeholder-text');
            if (resultsDiv) {
                resultsDiv.innerHTML = ''; // Clear previous results
            }
            if(placeholder) placeholder.style.display = 'block';

             // Clear all error messages
            document.querySelectorAll('.error-message').forEach(span => span.textContent = '');
        }


        function displayResults(results, containerId) {
            const resultsDiv = document.getElementById(containerId);
            if (!resultsDiv) return;

            let html = '';
            results.forEach(result => {
                html += `
                    <div class="result-item">
                        <span class="result-label">${result.label}:</span>
                        <span class="result-value">${result.value}</span>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            const placeholder = document.querySelector('#results-card-bow .placeholder-text');
            if(placeholder) placeholder.style.display = 'none';
            document.getElementById('results-card-bow').classList.remove('hidden');
        }

        function displayError(message, containerId = 'results-container-bow') {
            const resultsDiv = document.getElementById(containerId);
            if (!resultsDiv) return;
            resultsDiv.innerHTML = `<p style="color: var(--error-color); text-align: center; padding: 20px 0;">${message}</p>`;
            const placeholder = document.querySelector('#results-card-bow .placeholder-text');
            if(placeholder) placeholder.style.display = 'none';
            document.getElementById('results-card-bow').classList.remove('hidden');
        }

        // Tippy.js initialization
        tippy('[data-tippy-content]', {
            animation: 'scale-subtle',
            theme: 'light-border', // Or your custom theme
        });

        // Initialize with default calculation on forward tab
        window.addEventListener('load', function() {
            // Make sure the forward tab is active visually and logically
            switchTab('forward', document.querySelector('.tab-button.active'));
            // Optionally, run a default calculation if desired, or wait for user input
            // calculateForward(); // Uncomment if you want an initial calculation
            // Ensure placeholder is visible initially
            const placeholder = document.querySelector('#results-card-bow .placeholder-text');
            if(placeholder) placeholder.style.display = 'block';
             document.getElementById('results-card-bow').classList.remove('hidden'); // Show results card area
        });
    </script>
</body>
</html>